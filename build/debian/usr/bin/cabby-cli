#!/usr/bin/env bash

set -e

function usage() {
  echo "Usage: $0 -c [config path] -u [user name] -p [password]"
  exit 1
}

CABBY_ENV="${CABBY_ENVIRONMENT:-development}"

CABBY_SCHEMA="build/debian/var/cabby/schema.sql"
if [ "$CABBY_ENV" == "production" ]; then
  CABBY_SCHEMA="/var/cabby/schema.sql"
fi

CONFIG_PATH="config/cabby.json" # default dev config
CABBY_USER=""
PASS=""

while getopts ":c:hp:u:" opt; do
  case $opt in
    c)
      CONFIG_PATH="$OPTARG"
      ;;
    h)
      usage
      ;;
    p)
      PASS=$(printf "$OPTARG" | sha256sum | cut -d '-' -f 1 | xargs)
      ;;
    u)
      CABBY_USER="$OPTARG"
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument" >&2
      exit 1
      ;;
  esac
done

if [ ! -f "$CONFIG_PATH" ]; then
  echo "Config path $CONFIG_PATH does not exist"
  exit 1
fi

if [ -z $CABBY_USER ]; then
  echo "User not set"
  exit 1
fi

if [ -z $PASS ]; then
  echo "Password not set"
  exit 1
fi

DB_PATH=$(jq .$CABBY_ENV.data_store.path $CONFIG_PATH | sed 's/"//g')
DB_DIR=$(dirname $DB_PATH)

mkdir -p "$DB_DIR"
sqlite3 "$DB_PATH" ".read $CABBY_SCHEMA"

# set up user
echo "Creating a user"
sqlite3 $DB_PATH "insert into taxii_user (email) values('${CABBY_USER}')"
sqlite3 $DB_PATH "insert into taxii_user_pass (email, pass) values('${CABBY_USER}', '${PASS}')"

# set up discovery
sqlite3 $DB_PATH "
insert into taxii_discovery (title, description, contact, default_url) values(
  'a local taxii 2 server',
  'this is a test taxii2 server written in golang',
  'github.com/pladdy',
  'https://localhost/taxii/'
)"

# set up api root
echo "Creating an API Root"
API_ROOT=cabby_test_root

sqlite3 $DB_PATH "
insert into taxii_api_root (id, api_root_path, title, description, versions, max_content_length) values (
  'testId',
  '${API_ROOT}',
  'a title',
  'a description',
  'application/vnd.oasis.stix+json; version=2.0',
  8388608 /* 8 MB */
)"

# set up collection
echo "Creating a collection"
COLLECTION_ID=352abc04-a474-4e22-9f4d-944ca508e68c

sqlite3 $DB_PATH "
insert into taxii_collection (id, api_root_path, title, description, media_types) values (
  '${COLLECTION_ID}',
  '${API_ROOT}',
  'a test collection',
  'a test collection description',
  ''
)"

echo "Associate user to collection"
sqlite3 $DB_PATH "
insert into taxii_user_collection (email, collection_id, can_write, can_read) values (
  '${CABBY_USER}',
  '${COLLECTION_ID}',
  1,
  1
)"

if [ "$CABBY_ENV" == "production" ]; then
  echo "CABBY_ENVIRONMENT is production, changing ownership of $DB_PATH to cabby"
  chown cabby:cabby $DB_PATH
fi
